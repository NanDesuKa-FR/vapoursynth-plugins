
plugins = $(libdir)/vapoursynth/

ifeq ($(V), 1)
MAKE = make V=1
AUTORECONF = autoreconf -ivf
else
MAKE = make
AUTORECONF = autoreconf -if
endif

install = install -m644 -D
install_DIR = install -m755 -d

CLEANFILES = \
	aclocal.m4 \
	compile \
	config.guess \
	config.sub \
	configure \
	depcomp \
	install-sh \
	ltmain.sh \
	Makefile.in \
	missing

LIBS = \
	bifrost \
	combmask \
	convo2d \
	d2vsource \
	fieldhint \
	fillborders \
	fluxsmooth \
	genericfilters \
	histogram \
	msmoosh \
	mvtools \
	nnedi3 \
	rawsource \
	scrawl \
	scxvid \
	ssiq \
	tcomb \
	temporalsoften \
	vautodeint \
	videoscope \
	wwxd

execstack_LIBS = fluxsmooth nnedi3 tcomb

define NL


endef


all: clean
	$(foreach LIB,$(LIBS), cd $(LIB) && $(AUTORECONF) && ./configure && $(MAKE) ; cd .. ;)

install:
	$(install_DIR) $(DESTDIR)$(plugins)
	$(install_DIR) $(DESTDIR)$(docdir)
	$(foreach LIB,$(LIBS),$(install) $(LIB)/.libs/lib$(LIB).so $(DESTDIR)$(plugins) $(NL))
	$(install) vautodeint/VAutoDeint.py $(DESTDIR)$(plugins)
	$(foreach LIB,$(execstack_LIBS),$(execstack) --clear-execstack $(DESTDIR)$(plugins)/lib$(LIB).so $(NL))
	$(install) README $(DESTDIR)$(docdir)
	$(install) rawsource/format_list.txt $(DESTDIR)$(docdir)/rawsource_format_list
	$(foreach FILE,$(shell echo */readme* */README*), \
		$(install) $(FILE) $(DESTDIR)$(docdir)/$(shell echo $$(dirname $(FILE))) $(NL))

clean:
	($(foreach LIB,$(LIBS),cd $(LIB) && $(MAKE) clean ; cd .. ; )) || true

distclean:
	($(foreach LIB,$(LIBS),cd $(LIB) && $(MAKE) distclean ; cd .. ;)) || true
	rm -f Makefile

clobber: distclean
	$(foreach LIB,$(LIBS),rm -rf $(LIB)/autom4te.cache ; \
		cd $(LIB) && rm -f $(CLEANFILES) && cd .. ;)

